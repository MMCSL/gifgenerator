<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMC - SL Gif Creator (Clone Edition)</title>
    
    <script src="https://unpkg.com/gif-frames@1.0.1/dist/gif-frames.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0; color: #333; text-align: center; 
            padding: 20px; margin: 0; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- VISUAL ESTILO WINDOWS FORMS (Retrô) --- */
        .main-container { 
            width: 300px; background: #e6e6e6; 
            padding: 15px; border: 1px solid #999;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            text-align: left; font-size: 11px;
        }

        h1 { font-size: 14px; margin: 0 0 10px 0; color: #000; text-align: center; }
        
        .preview-box {
            width: 100px; height: 100px; border: 1px solid #999;
            background: #fff; display: inline-block; vertical-align: top;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .preview-box img { max-width: 100px; max-height: 100px; }

        .controls-right { display: inline-block; vertical-align: top; margin-left: 10px; width: 150px; }

        button {
            width: 100px; height: 25px; margin-bottom: 5px;
            background: #e1e1e1; border: 1px solid #adadad; cursor: pointer;
            font-size: 11px; color: #000;
        }
        button:hover { background: #e5f1fb; border-color: #0078d7; }
        button:disabled { color: #888; background: #f0f0f0; border-color: #ccc; }

        .status-lbl { color: #666; margin-bottom: 10px; display: block; }
        .info-lbl { margin-top: 5px; display: block; }

        input[type=checkbox] { margin-right: 5px; vertical-align: middle; }
        
        /* Ocultar input file */
        input[type=file] { display: none; }

        /* --- TELA DE BLOQUEIO --- */
        #lockedScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #d9534f;
        }
        .lock-screen-gif { max-width: 150px; margin-bottom: 20px; border-radius: 5px; }
        #appContent { display: none; }
        
        /* Canvas Oculto */
        canvas { display: none; }
    </style>
</head>
<body>

    <div id="lockedScreen">
        <img src="ERROR.gif" alt="Access Denied" class="lock-screen-gif">
        <h2 style="color: #d9534f; font-size: 2em; text-transform: uppercase;">Access Denied</h2>
        <p style="color: #888;">You need to use your in-world HUD to generate your access link.</p>
        <div id="lockReason" style="color: #666; font-family: monospace; margin-top: 10px;">Checking security...</div>
    </div>

    <div id="appContent">
        <div class="main-container">
            <h1>G2SLA Clone (Web)</h1>
            
            <div class="preview-box">
                <img id="previewImg" src="" alt="" style="display:none;">
                <span id="noImageLbl" style="color:#888;">No Image</span>
            </div>

            <div class="controls-right">
                <button onclick="document.getElementById('gifInput').click()">Load GIF</button>
                <span id="loadStatusLbl" class="status-lbl">No Image Loaded</span>
                
                <button id="outputBtn" disabled onclick="generateOutput()">Output</button>
                
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="transparentChkbox" checked> Transparency
                    </label>
                </div>
            </div>

            <div style="clear: both; margin-top: 15px;">
                <span id="framesLbl" class="info-lbl">Frames: </span>
                <span id="dimensionsLbl" class="info-lbl">Dimensions: </span>
                <span id="nameLbl" class="info-lbl">Name: </span>
            </div>

            <input type="file" id="gifInput" accept="image/gif">
            <canvas id="processCanvas"></canvas>
        </div>
        
        <p style="font-size: 10px; color: #888; margin-top: 10px;">
            Logic ported 1:1 from C# source code.<br>
            FPS fixed at 10. Grid logic matches original .exe.
        </p>
    </div>

<script>
    // ==========================================
    // 1. SEGURANÇA (MANTIDA DO TESTER.HTML)
    // ==========================================
    const SECRET_KEY = "MMC_SAORI_SECRET_2026";
    const LINK_EXPIRATION_MINUTES = 2; 

    function checkAccess() {
        const params = new URLSearchParams(window.location.search);
        const userUUID = params.get('id');
        const urlToken = params.get('token');
        const timestamp = params.get('ts'); 
        
        const lockReason = document.getElementById('lockReason');
        const lockedScreen = document.getElementById('lockedScreen');
        const appContent = document.getElementById('appContent');

        if (!userUUID || !urlToken || !timestamp) {
            lockReason.innerText = "Error: Invalid Link Format.";
            return;
        }

        const storageKey = "used_token_" + urlToken;
        if (localStorage.getItem(storageKey)) {
             lockReason.innerText = "Error: Link already used.";
             return;
        }

        const linkTime = parseInt(timestamp) * 1000;
        const now = new Date().getTime();
        if ((now - linkTime) / 1000 / 60 > LINK_EXPIRATION_MINUTES) {
            lockReason.innerText = "Error: Link Expired.";
            return;
        }

        const stringToHash = userUUID + timestamp + SECRET_KEY + ":0";
        const calculatedToken = CryptoJS.MD5(stringToHash).toString();

        if (urlToken === calculatedToken) {
            localStorage.setItem(storageKey, "true");
            lockedScreen.style.display = 'none';
            appContent.style.display = 'block'; // Mostra o app
        } else {
            lockReason.innerText = "Error: Security Token Mismatch.";
        }
    }
    checkAccess();

    // ==========================================
    // 2. LÓGICA PORTADA DO C# (G2SLA.cs)
    // ==========================================
    
    // Variáveis Globais (imitando a classe Form)
    let currentFrames = [];
    let xFrames = 0;
    let yFrames = 0;
    let fileName = "";
    let safeFileName = "";
    let outputFileName = "";
    
    const gifInput = document.getElementById('gifInput');
    const previewImg = document.getElementById('previewImg');
    const noImageLbl = document.getElementById('noImageLbl');
    const loadStatusLbl = document.getElementById('loadStatusLbl');
    const framesLbl = document.getElementById('framesLbl');
    const dimensionsLbl = document.getElementById('dimensionsLbl');
    const nameLbl = document.getElementById('nameLbl');
    const outputBtn = document.getElementById('outputBtn');
    const transparentChkbox = document.getElementById('transparentChkbox');
    const canvas = document.getElementById('processCanvas');

    // Load GIF (Button Click)
    gifInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        fileName = file.name;
        // Simula FileInfo.Name
        safeFileName = fileName;
        
        loadStatusLbl.innerText = "Loading...";
        
        const reader = new FileReader();
        reader.onload = function(event) {
            // Preview
            previewImg.src = event.target.result;
            previewImg.style.display = 'block';
            noImageLbl.style.display = 'none';
            loadStatusLbl.innerText = safeFileName;

            // Extrair Frames (Simula Image.FromFile)
            gifFrames({ url: event.target.result, frames: 'all', outputType: 'canvas', cumulative: true })
            .then(function (frames) {
                currentFrames = frames;
                computeOutput(); // Chama a lógica de cálculo
            });
        };
        reader.readAsDataURL(file);
    });

    // Lógica Exata do método computeOutput() do C#
    function computeOutput() {
        xFrames = 0;
        yFrames = 0;
        let frameCount = currentFrames.length;
        
        // int num = Convert.ToInt32(Math.Sqrt(frameCount));
        // Math.round é o equivalente mais próximo do ToInt32 padrão para arredondamento
        let num = Math.round(Math.sqrt(frameCount)); 
        let num2 = frameCount;

        if (num * num == frameCount) {
            xFrames = num;
            yFrames = num;
        } else {
            if (frameCount % 2 != 0) {
                num2++;
            }
            
            // Lógica condicional exata do C#
            if (num2 < 16) {
                xFrames = Math.floor(num2 / 2); // integer division
                yFrames = 2;
            } else if (num2 < 32) {
                xFrames = Math.floor(num2 / 4);
                yFrames = 4;
            } else if (num2 < 64) {
                xFrames = Math.floor(num2 / 8);
                yFrames = 8;
            } else {
                xFrames = Math.floor(num2 / 16);
                yFrames = 16;
            }
        }

        // Labels Update
        if (num2 != frameCount) {
            framesLbl.innerText = "Frames: " + frameCount + " + 1";
        } else {
            framesLbl.innerText = "Frames: " + frameCount;
        }

        dimensionsLbl.innerText = "Dimensions: " + xFrames + "x" + yFrames + " frames";
        
        // Naming Logic: .anim;X;Y;10 (HARDCODED 10 FPS)
        let nameBase = safeFileName.replace(".gif", "");
        outputFileName = nameBase + ".anim;" + xFrames + ";" + yFrames + ";10";
        nameLbl.innerText = "Name: " + outputFileName;

        outputBtn.disabled = false;
        return true;
    }

    // Lógica Exata do método outputBtn_Click()
    function generateOutput() {
        if (!currentFrames.length) return;

        loadStatusLbl.innerText = "Outputting...";
        
        // Pega dimensões do primeiro frame
        let tempImg = currentFrames[0].getImage();
        let width = tempImg.width;
        let height = tempImg.height;

        // Bitmap val = new Bitmap(...)
        canvas.width = xFrames * width;
        canvas.height = yFrames * height;
        let ctx = canvas.getContext('2d');

        // Lógica de loop do C#
        // Ele itera sobre a grade e pega o frame correspondente (num3)
        let num2 = currentFrames.length;
        if (num2 % 2 != 0) num2++; // Ajuste para ímpar

        let num3 = 0; // Índice do frame atual

        for (let i = 0; i < yFrames; i++) {
            for (let j = 0; j < xFrames; j++) {
                let frameToDraw = null;

                if (num3 < currentFrames.length) {
                    frameToDraw = currentFrames[num3];
                } else {
                    // Padding: Se acabou os frames, usa o primeiro (SelectActiveFrame(..., 0))
                    // Nota: O código C# usa o frame 0 como padding se num3 >= num2
                    frameToDraw = currentFrames[0];
                }

                // Desenha no Canvas (Substitui GetPixel/SetPixel)
                if (frameToDraw) {
                    let posX = j * width;
                    let posY = i * height;
                    ctx.drawImage(frameToDraw.getImage(), posX, posY);
                }

                num3++;
            }
        }

        // Resizing Logic (width > 1024 || height > 1024)
        if (canvas.width > 1024 || canvas.height > 1024) {
            loadStatusLbl.innerText = "Resizing image...";
            
            // Cria canvas temporário para resize
            let tempCanvas = document.createElement('canvas');
            let tCtx = tempCanvas.getContext('2d');
            
            // Lógica ternária do C#
            let num6 = (canvas.width > 1024) ? 1024 : canvas.width;
            let num7 = (canvas.height > 1024) ? 1024 : canvas.height;
            
            tempCanvas.width = num6;
            tempCanvas.height = num7;
            
            // DrawImage com qualidade (Browsers fazem bicubic por padrão ao reduzir)
            tCtx.drawImage(canvas, 0, 0, num6, num7);
            
            // Substitui canvas original
            canvas.width = num6;
            canvas.height = num7;
            ctx.drawImage(tempCanvas, 0, 0);
        }

        // Save Logic (JPG vs PNG)
        let finalFormat = "image/png";
        let finalExt = ".png";

        if (!transparentChkbox.checked) {
            // Se desmarcado -> JPG
            finalFormat = "image/jpeg";
            finalExt = ".jpg";
            
            // JPG no C# GDI+ preenche fundo transparente com preto automaticamente.
            // No Canvas HTML5, precisamos pintar preto antes se formos salvar como JPG,
            // pois conversão direta pode deixar artefatos ou fundo preto dependendo do browser.
            // Para garantir: Compositar sobre preto.
            let compositeCanvas = document.createElement('canvas');
            compositeCanvas.width = canvas.width;
            compositeCanvas.height = canvas.height;
            let cCtx = compositeCanvas.getContext('2d');
            cCtx.fillStyle = "#000000";
            cCtx.fillRect(0, 0, canvas.width, canvas.height);
            cCtx.drawImage(canvas, 0, 0);
            
            // Download
            triggerDownload(compositeCanvas.toDataURL("image/jpeg", 0.9), outputFileName + finalExt);
        } else {
            // PNG (Mantém transparência)
            triggerDownload(canvas.toDataURL("image/png"), outputFileName + finalExt);
        }

        loadStatusLbl.innerText = "Image produced.";
        alert("Image " + outputFileName + finalExt + " produced.");
    }

    function triggerDownload(url, filename) {
        const link = document.createElement('a');
        link.download = filename;
        link.href = url;
        link.click();
    }
</script>
</body>
</html>
