<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>G2SLA - Versão Robusta</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; text-align: center; padding: 20px; }
        .box { background: #333; max-width: 500px; margin: auto; padding: 20px; border-radius: 10px; border: 1px solid #555; }
        #preview { max-width: 150px; display: none; margin: 10px auto; border: 1px solid #777; }
        .log { background: #000; color: #0f0; padding: 10px; font-size: 12px; text-align: left; margin-top: 10px; border-radius: 5px; height: 100px; overflow-y: auto; }
        button { background: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 5px; margin-top: 10px; width: 100%; }
        button:disabled { background: #555; cursor: not-allowed; }
        .error-help { color: #ff6b6b; font-size: 13px; margin-top: 10px; display: none; border: 1px solid #ff6b6b; padding: 10px; }
    </style>
</head>
<body>

<div class="box">
    <h2>G2SLA - Conversor</h2>
    <input type="file" id="gifInput" accept="image/gif">
    <br>
    <img id="preview">
    
    <div id="info" style="margin: 15px 0; font-size: 14px; color: #ddd;">
        Selecione um GIF para começar
    </div>

    <label><input type="checkbox" id="transparentChk" checked> Transparência</label>
    <br>
    <button id="outputBtn" disabled>BAIXAR TEXTURA</button>
    
    <div class="log" id="statusLog">Aguardando...</div>
    
    <div id="errorHelp" class="error-help">
        <strong>ERRO CRÍTICO:</strong> O script não carregou.<br>
        1. Baixe este arquivo: <a href="https://unpkg.com/omggif@1.0.10/omggif.js" target="_blank" style="color: #fff;">omggif.js</a><br>
        2. Salve na mesma pasta que este html.<br>
        3. Recarregue a página.
    </div>
</div>

<script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
<script src="omggif.js"></script> 

<script>
    const gifInput = document.getElementById('gifInput');
    const outputBtn = document.getElementById('outputBtn');
    const statusLog = document.getElementById('statusLog');
    const info = document.getElementById('info');
    const preview = document.getElementById('preview');
    const errorHelp = document.getElementById('errorHelp');

    function log(msg) {
        statusLog.innerHTML += "<div>> " + msg + "</div>";
        statusLog.scrollTop = statusLog.scrollHeight;
    }

    // Verifica se a biblioteca carregou
    function checkLibrary() {
        if (typeof Omggif === 'undefined') {
            log("ERRO: Biblioteca Omggif não encontrada!");
            errorHelp.style.display = "block";
            return false;
        }
        return true;
    }

    gifInput.onchange = function(e) {
        if (!checkLibrary()) return;

        const file = e.target.files[0];
        if (!file) return;

        log("Lendo arquivo: " + file.name);
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
        outputBtn.disabled = true;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const buffer = new Uint8Array(event.target.result);
                // Usando Omggif para ler o GIF
                const gifReader = new Omggif.GifReader(buffer);
                
                const frameCount = gifReader.numFrames();
                if (frameCount === 0) throw new Error("Sem frames.");

                window.gifReader = gifReader; // Salva para uso posterior
                window.safeName = file.name.replace(/\.[^/.]+$/, "");
                
                calculateLayout(frameCount);
                log("GIF processado! " + frameCount + " frames.");
                outputBtn.disabled = false;

            } catch (err) {
                log("ERRO: " + err.message);
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    };

    function calculateLayout(frameCount) {
        let num = Math.floor(Math.sqrt(frameCount));
        let num2 = frameCount;
        let xFrames = 0, yFrames = 0;

        if (num * num === frameCount) {
            xFrames = num; yFrames = num;
        } else {
            if (num2 % 2 !== 0) num2++;
            if (num2 < 16) { xFrames = num2 / 2; yFrames = 2; }
            else if (num2 < 32) { xFrames = num2 / 4; yFrames = 4; }
            else if (num2 < 64) { xFrames = num2 / 8; yFrames = 8; }
            else { xFrames = Math.ceil(num2 / 16); yFrames = 16; }
        }

        window.layout = { x: xFrames, y: yFrames };
        info.innerHTML = `Frames: ${frameCount} <br> Grade: ${xFrames}x${yFrames}`;
    }

    outputBtn.onclick = function() {
        log("Gerando imagem...");
        const reader = window.gifReader;
        const layout = window.layout;
        const width = reader.width;
        const height = reader.height;

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        let totalW = layout.x * width;
        let totalH = layout.y * height;

        // Limite 1024px
        let scale = 1;
        if (totalW > 1024 || totalH > 1024) {
            log("Redimensionando para 1024px...");
            scale = Math.min(1024 / totalW, 1024 / totalH);
        }

        canvas.width = Math.floor(totalW * scale);
        canvas.height = Math.floor(totalH * scale);
        
        // Canvas temporário para extrair pixels brutos
        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = width;
        frameCanvas.height = height;
        const frameCtx = frameCanvas.getContext('2d');
        const frameData = frameCtx.createImageData(width, height);

        // Processar cada frame
        const numFrames = reader.numFrames();
        const dw = Math.floor(width * scale);
        const dh = Math.floor(height * scale);

        for (let i = 0; i < numFrames; i++) {
            // Decodifica pixels para o array
            reader.decodeAndBlitFrameRGBA(i, frameData.data);
            
            // Coloca no canvas temporário
            frameCtx.putImageData(frameData, 0, 0);

            // Calcula posição
            const col = i % layout.x;
            const row = Math.floor(i / layout.x);

            if (row < layout.y) {
                // Desenha no canvas final redimensionado
                ctx.drawImage(frameCanvas, col * dw, row * dh, dw, dh);
            }
        }

        // Baixar
        const isPng = document.getElementById('transparentChk').checked;
        const ext = isPng ? ".png" : ".jpg";
        const type = isPng ? "image/png" : "image/jpeg";
        const filename = `${window.safeName}.anim;${layout.x};${layout.y};10${ext}`;

        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL(type, 0.9);
        link.click();
        log("Download concluído: " + filename);
    };
</script>

</body>
</html>
